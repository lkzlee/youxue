<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>个人中心-我的消息_Camplink</title>
    <script src="js/isLogin.js"></script>
    <!--[if lt IE 9]>
    <script src="js/html5shiv.min.js"></script>
    <![endif]-->
    <script src="js/prefixfree.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/trip-calendar.css">
    <link rel="stylesheet" href="css/user.css">
</head>
<body>
<section class="header">
    <section class="head1 clear">
        <div class="left">
            <a href="#"> </a>
        </div>
        <div class="right">
            <div class="search">
                <input type="text"><div class="inco"><a href="search.html"></a></div>
            </div>
            <div class="car_inco"><a href="user_shoppingCar.html"></a></div>
            <div class="tel">
                <div class="inco"><a></a></div>
                <span>400-126-456</span>
            </div>
        </div>
    </section>
    <section class="head_nav">
        <div class="width_content">
            <nav>
                <div class="index_icon">
                    <a href="index.jsp"><i></i>首页</a>
                </div>
                <div class="about_icon ">
                    <a href="about.html"><i></i>关于我们</a>
                </div>
                <div class="news_icon ">
                    <a href="news.html"><i></i><span>Camplink</span>资讯</a>
                </div>
                <div class="private_icon ">
                    <a href="customized.html"><i></i>私人定制</a>
                </div>
                <div class="personal_icon" id="user_active">
                    <a href="login.html"><i></i>个人中心</a>
                </div>
            </nav>
        </div>
    </section>
</section>
<section class="user_default width_content clear">
    <ul class="left" id="userList">
        <li class="liActive"><a href="javascript:void(0)" class="a_userList">个人资料<span></span><i></i></a><!--∨∧-->
            <ul class="bounceInDown animated">
                <li><a href="user.html">基础信息</a></li>
                <li><a href="user_email_set.html">邮箱验证</a></li>
                <li><a href="user_message.html" class="li_a_liActive">我的消息</a></li>
            </ul>
        </li>
        <li><a href="javascript:void(0)" class="a_userList">我的订单<span></span><i></i></a>
            <ul>
                <li><a href="user_payment.html">待付款</a></li>
                <li><a href="user_audit.html">待审核</a></li>
                <li><a href="user_travel.html">待出行</a></li>
                <li><a href="user_finish.html">已完成</a></li>
                <li><a href="user_cancel.html">已取消</a></li>
            </ul>
        </li>
        <li><a href="javascript:void(0)" class="a_userList">我的购物车<span></span><i></i></a>
            <ul>
                <li><a href="user_shoppingCar.html">购物车</a></li><li><a href="user_product.html">周边产品</a></li>
            </ul>
        </li>
    </ul>
    <div class="right_message">
        <div class="right1">
            <div class="bghui">
                <span>发送消息</span>
                <select name="" id="date_select">
                    <option value="">--默认所有--</option>
                    <option value="0">一周内</option>
                    <option value="1">一个月内</option>
                    <option value="2">两个月内</option>
                    <option value="3">三个月内</option>
                </select>
            </div>
        </div>
        <div class="right2">
            <p>所有消息<span id="message_num"></span></p>
            <ul class="border_div">
                <li class="head_boder li_border">
                    <label class="all_checked"><input type="checkbox" class="checkAll">全选</label>
                    <span class="cont_span">内容</span>
                    <span class="time_span">发送时间</span>
                </li>
                <li>
                    <form id="frm_list">
                        <ul id="message_ul">

                        </ul>
                    </form>
                </li>
                <li class="foot_boder li_border">
                    <label class="all_checked" for="all_checked2"><input type="checkbox" id="all_checked2" class="checkAll">全选</label>
                    <a href="javascript:void(0)" class="checkShow" id="delete" style="display:none;">删除</a>
                    <a href="javascript:void(0)" class="checkShow" id="signRead" style="display:none;">标记为已读</a>
                </li>
            </ul>
            <div class="page"></div>
        </div>
    </div>
</section>
<section class="footer">
    <div class="div1_foot">
        <span class="span1">公司地址：北京市海淀区中关村南大街铸诚大厦B座</span>
        <span class="span2">加入我们：hr@chingoo.cn</span>
        <span class="span1">客服电话：010-59460305</span>
        <span class="span2">公司邮箱：chingoo@chingoo.cn</span>
    </div>
    <div class="div2_foot">
        <p class="p1_foot">营联天下 版权所有</p>
        <p class="p2_foot">copyright 2016-2017，camplink.cn. Powered by iGalaxy</p>
    </div>
</section>
<script src="js/jquery-3.1.0.min.js"></script>
<script src="js/jquery.easing.min.js"></script>
<script src="js/public.js"></script>
<script src="js/user.js"></script>
<script>
    var public_obj={};
    $(function(){
        var checkArr=[];

        $('#message_ul').on('change','input[type="checkbox"]',function(){
            var len=$('#message_ul li').length;
            var isCheck=$(this).is(':checked');
            if(isCheck){
                checkArr.push($(this)[0].value);
            }else{
                checkArr.splice(checkArr.indexOf($(this)[0].value),1)
            }
            if(len==checkArr.length){
                $('.checkAll').prop('checked',true);
            }else{
                $('.checkAll').prop('checked',false);
            }
            changeElement($('.checkShow'),Boolean(checkArr.length));//因为空数组的length转bool是false，数组有值就是true
        })
        $('.checkAll').change(function(){
            checkArr=[];
            var childCheck=$('#message_ul input[type="checkbox"]');
            var isCheck=$(this).is(':checked');
            $('.checkAll').prop('checked',isCheck);
            childCheck.prop('checked',isCheck);
            changeElement($('.checkShow'),isCheck);
            if(isCheck){
                childCheck.each(function(){
                    checkArr.push($(this).prop('value'));
                })
            }
        })
        $('#delete').click(function(){
            var checked=$('#message_ul input[type="checkbox"]:checked');
            var childCheck=checked.serialize();
            
            login_post('/uc/delmessage.do',childCheck,'',function(data){
                data=JSON.parse(data);
                user_success(data,function(){
                    checked.each(function(){
                        $(this).closest('li').hide();
                    })
                })
            })
        })
        $('#signRead').click(function(){
            var checked=$('#message_ul input[type="checkbox"]:checked');
            var childCheck=checked.serialize();

            login_post('/uc/markmessage.do',childCheck,'',function(data){
                data=JSON.parse(data);
                user_success(data,function(){
                    $('.checkAll').prop('checked',false);
                    checked.each(function(){
                        $(this).prop({'checked':false}).closest('li').removeClass('weidu').addClass('yidu');
                    })
                    // $('#message_ul input:checked').prop({'checked':false}).closest('.cont_border').removeClass('weidu').addClass('yidu');
                })
            })
        })
        $('#message_ul').on('click','.j_title',function(){
            var That=$(this);
            var messageId=$(this).siblings('label').children('input').attr('value');
            login_post('/uc/markmessage.do','messageId='+messageId,'',function(data){
                data=JSON.parse(data);
                user_success(data,function(){
                    That.parent().removeClass('weidu').addClass('yidu');
                    // $('#message_ul input:checked').prop({'checked':false}).closest('.cont_border').removeClass('weidu').addClass('yidu');
                })
            })
        })
        $('#date_select').change(function(){//下拉根据日期-加载消息列表及分页
            var vals=$(this).val();
//            var dataObj={};
            if(vals){
                public_obj={
                    'startDate':vals==0?getWeek():getMonth(vals)
                }
            }else{
                public_obj={};
            }
//            console.log(public_obj);
            dyna_list();
        })
        change_page('.page',public_obj,function(data){
            public_obj['pageNo']=data.pageNo;
            public_obj['totalPage']=data.totalPage;
            public_obj['totalCount']=data.totalCount;
            console.log(data);
            dyna_list();
        });
        dyna_list();//加载消息列表及分页
    })
    function dyna_list(){
        login_post('/uc/usermessage.do',public_obj || '','',function(data){
            data=JSON.parse(data);
            user_success(data,function(){
                render_list(data);
            })
        })
    }
    //渲染消息列表
    function render_list(data){
//        data.pageNo=5;
//        data.totalPage=10;
//        data.totalCount=100;
        public_obj['pageNo']=data.pageNo;
        public_obj['totalPage']=data.totalPage;
        public_obj['totalCount']=data.totalCount;
        $('#message_num').text('(共'+data['totalCount']+'条，未读消息'+data['unReadCount']+'条)');
        var resultList=data['resultList'];
        var arr=[];
        var len=resultList.length;
        if(len<=0){
            arr.push('<li class="noMessage_border">您目前没有任何消息</li>');
        }else{
            for(var i=0;i<len;i++){
                var cName=resultList[i].readStatus==0?'weidu':'yidu';
                arr.push('<li class="cont_border li_border '+cName+'"><label><input name="messageId" type="checkbox" value="'+resultList[i]['messageId']+'">'+resultList[i]['messageTitle']+'</label><span class="cont_span j_title">'+resultList[i]['messageContent']+'</span><span class="time_span">'+resultList[i]['updateTime']+'</span></li>');
            }
        }
        $('.page').html(pageSet(public_obj).join(''));
        $('#message_ul').html(arr.join(''));
    }
    function changeElement(element,isCheck){
        if(isCheck){
           element.show();
       }else{
           element.hide();
       }
    }
</script>
</body>
</html>