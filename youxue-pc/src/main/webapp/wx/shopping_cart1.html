<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>shopping_cart</title>
    <link rel="stylesheet" href="css/cssReset.css"/>
    <link rel="stylesheet" href="css/shopping_cart.css"/>
</head>
<body>
<header>
    <p>您购买的营地我们会尽快确认，确认无误后订单状态为“待出行”，若确认购买失败，将会全额退还。咨询热线：<a href="tel:4008-517-517">4008-517-517</a></p>
</header>
<section>
    <ul>
        
        <!-- <li class="cf">
            <div class="cf choice_goods">
                <p class="common_choice J_check"><i></i></p>
                <div class="container">
                    <div class="cf move_path">
                        <img src="img/stu.png"/>
                        <div class="js_calc_width">
                            <p>暑假假期 美国贵族小学 亲子体验夏令营</p>
                            <p class="price">价格 ¥ <span>1799</span></p>
                        </div>
                        <button>删除</button>
                    </div>
                </div>
            </div>
            <div class="cf cart_edit">
                <p>数量  <span>1</span></p>
                <div class="cart_edit_number hidden_active">
                    <span class="sub_button"></span><input type="text" value="1"><span class="sum_button"></span>
                </div>
                <div class="cart_edit_choice">
                    编辑
                </div>
            </div>
        </li> -->
    </ul>
</section>
<footer class="cf">
    <div class="fl all_choice"><p class="common_choice"><i></i></p> 全选 </div>
    <button class="fr">结算</button>
    <div class="fr shopping_total">合计：￥ <span class="j_money_car">0</span></div>
</footer>
<script src="js/jquery-3.1.0.min.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/common.js"></script>
<script>
var dataObj={
    checkedCount_car:0,
    moneyTotal:0,
    numTotal:0,
    len:0
};
FastClick.attach(document.body);
var ul=$('ul'),all_choice=$('.all_choice');
$(function(){
    getCar();
})
ul.on('click','.J_check',function(){
    var This=$(this)
    var money=Number(This.attr('data-price'));
    var numCar=Number(This.attr('data-count'));
    if(!elementIsCheck(This.find('.active'))){
        addNumAndPrice_changeStyle(This,numCar,money)
    }else{
        subNumAndPrice_changeStyle(This,numCar,money)
    }
    isAll()
    change_total(money);
})
function addNumAndPrice_changeStyle(This,numCar,money){
    dataObj['checkedCount_car']=accAdd(dataObj['checkedCount_car'],1);
    dataObj['numTotal']=accAdd(dataObj['numTotal'],numCar);
    // dataObj['moneyTotal']=accAdd(dataObj['moneyTotal'],money*numCar);
    This.find('i').addClass('active');
}
function subNumAndPrice_changeStyle(This,numCar,money){
    dataObj['checkedCount_car']=accSub(dataObj['checkedCount_car'],1);
    dataObj['numTotal']=accSub(dataObj['numTotal'],numCar);
    // dataObj['moneyTotal']=accSub(dataObj['moneyTotal'],money*numCar);
    This.find('i').removeClass('active');
}
//数量点击增加
ul.on('click','.sum_button',function(){
    var number=Number($(this).siblings('.j_number').val())+1;
    $(this).siblings('.j_number').val(number);    
})
//数量点击减少
ul.on('click','.sub_button',function(){
    var number=Number($(this).siblings('.j_number').val())-1;
    $(this).siblings('.j_number').val(number || 1);
})
ul.on('click','.cart_edit_choice',function(){
    var text=$(this).text();
    var check=$(this).parents('li.cf').find('.J_check');
    var price=check.attr('data-price');
    $(this).text(text=="编辑"?"保存":"编辑");
    $(this).siblings('p').toggleClass('hidden_active');
    $(this).siblings('.cart_edit_number').toggleClass('hidden_active');
    var count=$(this).siblings('.cart_edit_number').find('.j_number').val();
    // var price=danjia*count;
    check.attr({'data-count':count,'data-price':price});
    dataObj['numTotal']=accAdd(dataObj['numTotal'],numCar);
    $(this).siblings('p').find('span').text(count);
    if(text=="保存" && elementIsCheck($(this).parents('li.cf').find('.active'))){
        addNumAndPrice_changeStyle(check,count,price);
        change_total(price);
        // $(this).parents('li.cf').find('.active').removeClass('active');
        // dataObj['moneyTotal']-=Number($(this).parents('li.cf').find('.J_check').attr('data-price'));
        // change_total();
    }
})
all_choice.on('click',function(){
    var totalPrice=$('#j_totalPrice').val();
    var J_check=$('.J_check');
    if(!elementIsCheck($(this).find('.active'))){
        J_check.each(function(){
            var This=$(this);
            var money=Number(This.attr('data-price'));
            var numCar=Number(This.attr('data-count'));
            addNumAndPrice_changeStyle(This,numCar,money)
        })
    }else{
        J_check.each(function(){
            var This=$(this);
            var money=Number(This.attr('data-price'));
            var numCar=Number(This.attr('data-count'));
            subNumAndPrice_changeStyle(This,numCar,money)
        })
    }
    isAll()
    change_total();
});
function elementIsCheck(active){
    if(active.length>0){
        return true;
    }
    return false;
}
function isAll(){
    if(dataObj['checkedCount_car']==dataObj['len']){
        all_choice.find('i').addClass('active');
    }else{
        all_choice.find('i').removeClass('active');
    }
}
function change_total(money){
    console.log(Number(dataObj['numTotal'])+'*'+money)
    $('.j_money_car').text(Number(dataObj['numTotal'])*money);
}
function getCar(){
    login_post('/shopCartDetailList.do','','',function(data){
        data=JSON.parse(data);
        user_success(data,function(){
            renderCar(data);
        })
    })
}
function renderCar(data){
    var arr=[];
    var source=data.shopCartList;
    dataObj['len']=source.length;
    if(dataObj['len']<=0){
        $('ul').html('<li class="noMessage_border">您的购物车还是空的，赶紧行动吧！</li>')
    }else{
        var price=0,count=0;
        for(var i=0;i<dataObj['len'];i++){
            price+=source[i].totalPrice*source[i].cartBuyCount;
            arr.push('<li class="cf"><div class="cf choice_goods"><p class="common_choice J_check" data-price="'+source[i].totalPrice+'" data-count="'+source[i].cartBuyCount+'"><i></i></p>');
            arr.push('<div class="container"><div class="cf move_path"><img src="'+handle_pic(source[i].campsImages)[0]+'"/><div class="js_calc_width">');
            arr.push('<p>'+source[i].campsTitle+'</p><p class="price">价格 ¥ <span>'+source[i].totalPrice+'</span></p></div><button>删除</button></div></div></div>');
            arr.push('<div class="cf cart_edit"><p>数量<span>'+source[i].cartBuyCount+'</span></p><div class="cart_edit_number hidden_active"><span class="sub_button"></span>');
            arr.push('<input class="j_number" type="number" value="'+source[i].cartBuyCount+'"><span class="sum_button"></span></div><div class="cart_edit_choice">编辑</div></div></li>');
            

            // arr.push('<li><input type="checkbox" id="checked'+(source[i].campsId)+'" name="campusId" value="'+source[i].campsId+'"><label class="check_label" for="checked'+source[i].campsId+'"><div></div></label>');
            // arr.push('<a class="yingdi_title" href="/info.jsp?campusId='+source[i].campsId+'"><img src="'+handle_pic(source[i].campsImages)[0]+'" alt=""><span class="span3">'+source[i].campsTitle+'</span></a>');
            // arr.push('<span class="span4">'+source[i].totalPrice+'</span><span class="span5 num_span_car">'+source[i].cartBuyCount+'</span><span class="span6 money_span_car">'+(source[i].totalPrice*source[i].cartBuyCount)+'</span><a href="javascript:void(0)" class="span7 child_del">删除</a></li>');
        }
        arr.push('<input type="hidden" id="j_totalPrice" value="'+price+'"/>');
        $('ul').html(arr.join(''));
    }
}
</script>
</body>
</html>